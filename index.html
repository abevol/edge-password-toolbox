<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Convert and compare password files between Microsoft Edge and Bitwarden | Âú® Microsoft Edge Âíå Bitwarden ‰πãÈó¥ËΩ¨Êç¢ÂíåÂØπÊØîÂØÜÁ†ÅÊñá‰ª∂">
    <meta name="keywords" content="Edge, Bitwarden, password manager, password conversion, password comparison, ÂØÜÁ†ÅÁÆ°ÁêÜÂô®, ÂØÜÁ†ÅËΩ¨Êç¢, ÂØÜÁ†ÅÂØπÊØî">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Edge Password Toolbox | Edge ÂØÜÁ†ÅÂ∑•ÂÖ∑ÁÆ±">
    <meta property="og:description" content="Convert and compare password files between Microsoft Edge and Bitwarden | Âú® Microsoft Edge Âíå Bitwarden ‰πãÈó¥ËΩ¨Êç¢ÂíåÂØπÊØîÂØÜÁ†ÅÊñá‰ª∂">
    <meta property="og:type" content="website">
    <title data-i18n="title">Edge Password Toolbox | Edge ÂØÜÁ†ÅÂ∑•ÂÖ∑ÁÆ±</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
        }
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            text-align: center;
            transform: translateY(0);
        }
        button:hover {
            background-color: #45a049;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #convertResult, #compareResult {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            justify-content: center;
            gap: 10px;
        }
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border: 2px solid #ddd;
            border-bottom: none;
            margin-bottom: 0px;
            background-color: #f5f5f5;
            color: #555;
            font-weight: bold;
            font-size: 16px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            text-align: center;
            min-width: 160px;
            transform: translateY(0px);
        }
        .tab:hover {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .tab.active {
            border-color: #4CAF50;
            border-bottom-color: white;
            border-bottom: none;
            margin-bottom: -2px;
            background-color: white;
            color: #2e7d32;
            box-shadow: 0 -3px 6px rgba(0,0,0,0.1);
            transform: translateY(0);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ffeeba;
            border-radius: 4px;
        }
        .warning-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .tab-description {
            background-color: #f8f9fa;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #666;
            line-height: 1.5;
        }
        .security-notice {
            color: #2e7d32;
            padding: 12px;
            margin: 10px 0 20px;
            border-radius: 4px;
            background-color: #e8f5e9;
            text-align: center;
            font-weight: 500;
        }
        .security-notice::before {
            content: 'üõ°Ô∏è';
            margin-right: 8px;
        }
        .file-label {
            color: #333;
            margin-top: 15px;
            display: block;
        }
        .language-selector {
            display: inline-flex;
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 2px;
        }
        .language-selector input[type="radio"] {
            display: none;
        }
        .language-selector label {
            padding: 6px 16px;
            color: #666;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
            margin: 0;
            display: block;
        }
        .language-selector label:hover {
            color: #333;
        }
        .language-selector input[type="radio"]:checked + label {
            background: white;
            color: #333;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .format-info {
            margin-top: 8px;
            padding: 8px 12px;
            background-color: #e8f5e9;
            border-radius: 4px;
            color: #2e7d32;
            font-weight: 500;
        }
        .format-info::before {
            content: 'üîç';
            margin-right: 8px;
        }
    /* GitHub Corner Ê†∑Âºè - ÂÆπÂô®ÂÜÖÈÉ® */
    .container {
        position: relative;
    }
    .github-corner {
        position: absolute;
        top: 0;
        right: 0;
        border: 0;
        z-index: 999;
    }
    .github-corner:hover .octo-arm {
        animation: octocat-wave 560ms ease-in-out;
    }
    .github-corner svg {
        fill: #4CAF50;
        color: #fff;
    }
    @keyframes octocat-wave {
        0%, 100% {
            transform: rotate(0);
        }
        20%, 60% {
            transform: rotate(-25deg);
        }
        40%, 80% {
            transform: rotate(10deg);
        }
    }
    @media (max-width: 500px) {
        .github-corner:hover .octo-arm {
            animation: none;
        }
        .github-corner .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
        }
    }
    </style>
</head>
<body>

    <div class="container">
        <a href="https://github.com/abevol/edge-password-toolbox" target="_blank" class="github-corner" aria-label="View source on GitHub">
            <svg width="60" height="60" viewBox="0 0 250 250" style="position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
                <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
            </svg>
        </a>
        <div style="display: flex; justify-content: flex-start; margin-bottom: 10px;">
            <div class="language-selector">
                <input type="radio" name="language" id="lang-zh" value="zh" checked onchange="switchLanguage('zh')">
                <label for="lang-zh">‰∏≠Êñá</label>
                <input type="radio" name="language" id="lang-en" value="en" onchange="switchLanguage('en')">
                <label for="lang-en">English</label>
            </div>
        </div>
        <h1 data-i18n="title"></h1>
        <div class="security-notice" data-i18n="security_notice"></div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('convert')" data-i18n="tabs.convert"></div>
            <div class="tab" onclick="switchTab('compare')" data-i18n="tabs.compare"></div>
        </div>

        <div id="convertTab" class="tab-content active">
            <div class="tab-description" data-i18n="convert.description"></div>
            <div class="form-group">
                <label for="csvFile" data-i18n="convert.selectFile"></label>
                <input type="file" id="csvFile" accept=".csv" onchange="detectFileFormat(this)">
                <div id="formatInfo" class="format-info" style="display: none;">
                    <span data-i18n="convert.detectedFormat"></span>: <span id="detectedFormat"></span>
                </div>
            </div>
            <button onclick="convertFile()" data-i18n="convert.convert"></button>
            <div id="convertResult" style="display: none;">
                <div class="warning-title" data-i18n="messages.noUrl"></div>
                <div class="warning">
                    <div id="noUrlRecordsList"></div>
                </div>
            </div>
        </div>

        <div id="compareTab" class="tab-content">
            <div class="tab-description" data-i18n="compare.description"></div>
            <div class="form-group">
                <label class="file-label" data-i18n="compare.file1"></label>
                <input type="file" id="csvFile1" accept=".csv" onchange="detectFileFormat(this, 'formatInfo1', 'detectedFormat1')">
                <div id="formatInfo1" class="format-info" style="display: none;">
                    <span data-i18n="convert.detectedFormat"></span>: <span id="detectedFormat1"></span>
                </div>
            </div>
            <div class="form-group">
                <label class="file-label" data-i18n="compare.file2"></label>
                <input type="file" id="csvFile2" accept=".csv" onchange="detectFileFormat(this, 'formatInfo2', 'detectedFormat2')">
                <div id="formatInfo2" class="format-info" style="display: none;">
                    <span data-i18n="convert.detectedFormat"></span>: <span id="detectedFormat2"></span>
                </div>
            </div>
            <button onclick="compareFiles()" data-i18n="compare.compare"></button>
            <div id="compareResult" style="display: none;">
                <div id="noMismatchDiv" style="display: none;">
                    <div class="warning" data-i18n="compare.noMismatch"></div>
                </div>
                <div id="hasMismatchDiv" style="display: none;">
                    <div class="warning-title" data-i18n="compare.foundMismatch"></div>
                    <div id="mismatchList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÈõÜ‰∏≠ÁÆ°ÁêÜÊâÄÊúâÁøªËØëÊñáÊú¨
        const i18n = {
            zh: {
                title: 'Edge ÂØÜÁ†ÅÂ∑•ÂÖ∑ÁÆ±',
                tabs: {
                    convert: 'Ê†ºÂºèËΩ¨Êç¢',
                    compare: 'ÂØÜÁ†ÅÂØπÊØî'
                },
                security_notice: 'Á∫ØÂâçÁ´ØÂÆûÁé∞ÔºåÊâÄÊúâÊï∞ÊçÆÂ§ÑÁêÜÂú®Êú¨Âú∞ÂÆåÊàêÔºåÊó†ÈúÄ‰∏ä‰º†Âà∞ÊúçÂä°Âô®ÔºåÂÆâÂÖ®ÂèØÈù†„ÄÇ',
                convert: {
                    description: 'Â∞Ü CSV ÂØÜÁ†ÅÊñá‰ª∂Âú®‰∏çÂêåÂπ≥Âè∞Ê†ºÂºè‰πãÈó¥ËøõË°åËΩ¨Êç¢„ÄÇÁõÆÂâçÊîØÊåÅÂú® Bitwarden Âíå Microsoft EdgeÔºàÂÖºÂÆπ Google ChromeÔºâ ‰πãÈó¥‰∫íÁõ∏ËΩ¨Êç¢„ÄÇ',
                    sourceFormat: 'Ê∫êÊñá‰ª∂Âπ≥Âè∞Ê†ºÂºèÔºö',
                    selectFile: 'ÈÄâÊã©ÂØÜÁ†ÅÊñá‰ª∂Ôºö',
                    convert: 'ËΩ¨Êç¢',
                    detectedFormat: 'Ê£ÄÊµãÂà∞Êñá‰ª∂Ê†ºÂºè',
                    formatBitwarden: 'Bitwarden',
                    formatEdge: 'Microsoft Edge',
                    formatUnknown: 'Êú™Áü•'
                },
                compare: {
                    description: 'ÂØπÊØî‰∏§‰∏™‰∏çÂêåÁöÑ CSV ÂØÜÁ†ÅÊñá‰ª∂ÔºåÊâæÂá∫ÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÁöÑËÆ∞ÂΩïÔºåÊñπ‰æøÂú®Â∞ÜÂØÜÁ†ÅÂØºÂÖ•Âè¶‰∏ÄÂπ≥Âè∞‰πãÂâçËøõË°åÊ£ÄÊü•‰øÆÊîπ‰ª•ÈÅøÂÖçÂºïËµ∑ÂÜ≤Á™ÅÔºõ‰∫¶ÂèØÂêåÊñá‰ª∂Ëá™ÊØî‰ª•Ëá™ÊàëÊ£ÄÊü•„ÄÇ',
                    file1: 'Êñá‰ª∂ 1Ôºö',
                    file2: 'Êñá‰ª∂ 2Ôºö',
                    compare: 'ÂØπÊØî',
                    noMismatch: 'Ê≤°ÊúâÂèëÁé∞ÂØÜÁ†Å‰∏çÂåπÈÖçÁöÑËÆ∞ÂΩï„ÄÇ',
                    foundMismatch: 'ÂèëÁé∞‰ª•‰∏ãÂØÜÁ†Å‰∏çÂåπÈÖçÔºö',
                    username: 'Áî®Êà∑Âêç',
                    record: 'ËÆ∞ÂΩï',
                    name: 'ÂêçÁß∞',
                    password: 'ÂØÜÁ†Å'
                },
                messages: {
                    selectFile: 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™CSVÊñá‰ª∂',
                    selectFiles: 'ËØ∑ÈÄâÊã©‰∏§‰∏™Ë¶ÅÂØπÊØîÁöÑÊñá‰ª∂',
                    compareError: 'ÂØπÊØîÊñá‰ª∂Êó∂Âá∫Èîô: ',
                    noUrl: 'ÂèëÁé∞‰ª•‰∏ãËÆ∞ÂΩï‰∏çÂ≠òÂú® URL Â≠óÊÆµÔºåÂÆÉ‰ª¨Â∞Ü‰∏ç‰ºöË¢´ Edge ËØÜÂà´ÂíåÂØºÂÖ•Ôºö',
                    formatError: 'Êó†Ê≥ïËØÜÂà´Êñá‰ª∂Ê†ºÂºèÔºåËØ∑Á°Æ‰øù‰∏ä‰º†ÁöÑÊòØÊúâÊïàÁöÑ Bitwarden Êàñ Microsoft Edge ÂØÜÁ†ÅÊñá‰ª∂'
                }
            },
            en: {
                title: 'Edge Password Toolbox',
                security_notice: 'Pure frontend implementation, all data processing is done locally, no server upload required, secure and reliable.',
                tabs: {
                    convert: 'Format Conversion',
                    compare: 'Password Comparison'
                },
                convert: {
                    description: 'Convert CSV password files between different platforms. Currently supports conversion between Bitwarden and Microsoft Edge (compatible with Google Chrome).',
                    sourceFormat: 'Source Platform Format:',
                    selectFile: 'Select Password File:',
                    convert: 'Convert',
                    detectedFormat: 'Detected Format',
                    formatBitwarden: 'Bitwarden',
                    formatEdge: 'Microsoft Edge',
                    formatUnknown: 'Unknown'
                },
                compare: {
                    description: 'Compare CSV password files to find inconsistent records, helping you check and modify passwords before importing to another platform without conflicts; also supports self-checking by comparing a file with itself.',
                    file1: 'File 1:',
                    file2: 'File 2:',
                    compare: 'Compare',
                    noMismatch: 'No password mismatches found.',
                    foundMismatch: 'Found the following password mismatches:',
                    username: 'Username',
                    record: 'Record',
                    name: 'Name',
                    password: 'Password'
                },
                messages: {
                    selectFile: 'Please select a CSV file',
                    selectFiles: 'Please select two files to compare',
                    compareError: 'Error comparing files: ',
                    noUrl: 'The following records have no URL field and will not be recognized and imported by Edge:',
                    formatError: 'Unable to recognize file format, please ensure you upload a valid Bitwarden or Microsoft Edge password file'
                }
            }
        };

        // Ëé∑ÂèñÁøªËØëÊñáÊú¨ÁöÑËæÖÂä©ÂáΩÊï∞
        function t(key, params = {}) {
            const keys = key.split('.');
            let value = i18n[currentLanguage];
            
            for (const k of keys) {
                value = value[k];
                if (value === undefined) {
                    console.warn(`Translation key not found: ${key}`);
                    return key;
                }
            }

            // ÊîØÊåÅÊ®°ÊùøÂ≠óÁ¨¶‰∏≤ÊõøÊç¢
            return value.replace(/\${(\w+)}/g, (_, param) => params[param] || '');
        }

        // ‰ªé localStorage Ëé∑Âèñ‰øùÂ≠òÁöÑËØ≠Ë®ÄËÆæÁΩÆ
        let currentLanguage = localStorage.getItem('language') || 'zh';

        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', currentLanguage);
            document.documentElement.lang = currentLanguage === 'zh' ? 'zh-CN' : 'en';
            
            // Êõ¥Êñ∞ÂçïÈÄâÊ°ÜÁä∂ÊÄÅ
            document.querySelectorAll('input[name="language"]').forEach(radio => {
                radio.checked = radio.value === currentLanguage;
            });
            
            updateLanguage();
        }

        function updateLanguage() {
            // Êõ¥Êñ∞ÊâÄÊúâÂ∏¶Êúâ data-i18n Â±ûÊÄßÁöÑÂÖÉÁ¥†
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (element.tagName.toLowerCase() === 'title') {
                    // ÂØπ‰∫é title Ê†áÁ≠æÔºåÂêåÊó∂Êõ¥Êñ∞ document.title
                    const text = t(key);
                    element.textContent = text;
                    document.title = text;
                } else {
                    element.textContent = t(key);
                }
            });
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñËØ≠Ë®Ä
        document.addEventListener('DOMContentLoaded', () => {
            // Ê†πÊçÆ‰øùÂ≠òÁöÑËØ≠Ë®ÄËÆæÁΩÆÂàùÂßãÂåñÂçïÈÄâÊ°Ü
            document.querySelectorAll('input[name="language"]').forEach(radio => {
                radio.checked = radio.value === currentLanguage;
            });
            updateLanguage();
        });

        function switchTab(tabName) {
            // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
            const selectedTab = document.querySelector(`.tab:nth-child(${tabName === 'convert' ? '1' : '2'})`);
            const selectedContent = document.getElementById(`${tabName}Tab`);
            selectedTab.classList.add('active');
            selectedContent.classList.add('active');
        }

        async function compareFiles() {
            const fileInput1 = document.getElementById('csvFile1');
            const fileInput2 = document.getElementById('csvFile2');
            const file1 = fileInput1.files[0];
            const file2 = fileInput2.files[0];
            
            if (!file1 || !file2) {
                alert(t('messages.selectFiles'));
                return;
            }
            
            // Ëé∑ÂèñÊ£ÄÊµãÂà∞ÁöÑÊ†ºÂºè
            const format1 = fileInput1.getAttribute('data-format');
            const format2 = fileInput2.getAttribute('data-format');
            
            if (!format1 || format1 === 'unknown' || !format2 || format2 === 'unknown') {
                alert(t('messages.formatError'));
                return;
            }

            try {
                const content1 = await readFileContent(file1);
                const content2 = await readFileContent(file2);

                const data1 = normalizePasswordData(content1, format1);
                const data2 = normalizePasswordData(content2, format2);

                const differences = findDifferences(data1, data2);
                displayDifferences(differences, file1.name, file2.name);
            } catch (error) {
                console.error(t('messages.compareError'), error);
                alert(t('messages.compareError') + error.message);
            }
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('ËØªÂèñÊñá‰ª∂Â§±Ë¥•'));
                reader.readAsText(file);
            });
        }

        function extractDomainFromUrl(url) {
            try {
                // Â∞ùËØï‰ΩøÁî® URL ÊûÑÈÄ†ÂáΩÊï∞Ëß£Êûê URL
                const urlObj = new URL(url);
                return urlObj.hostname;
            } catch (e) {
                // Â¶ÇÊûú URL Êó†ÊïàÔºåÂ∞ùËØï‰ΩøÁî®ÁÆÄÂçïÁöÑÊ≠£ÂàôË°®ËææÂºèÊèêÂèñÂüüÂêç
                const match = url.match(/^(?:https?:\/\/)?([^\/]+)/i);
                return match ? match[1] : url;
            }
        }

        function parseLoginUris(uriString) {
            // Â¶ÇÊûúÂ≠óÁ¨¶‰∏≤‰∏∫Á©∫ÔºåËøîÂõûÁ©∫Êï∞ÁªÑ
            if (!uriString) return [''];
            
            const result = [];
            let currentUri = '';
            let inQuotes = false;
            
            for (let i = 0; i < uriString.length; i++) {
                const char = uriString[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(currentUri.trim());
                    currentUri = '';
                } else {
                    currentUri += char;
                }
            }
            
            if (currentUri) {
                result.push(currentUri.trim());
            }
            
            // ÁßªÈô§Â§ö‰ΩôÁöÑÂºïÂè∑
            return result.map(uri => uri.replace(/^"(.*)"$/, '$1').trim());
        }

        function normalizePasswordData(csvContent, format) {
            const lines = parseCSV(csvContent);
            const data = lines.slice(1); // Ë∑≥ËøáÊ†áÈ¢òË°å
            const result = [];

            data.forEach(row => {
                if (format === 'bitwarden') {
                    if (row.length >= 10) {
                        const uris = parseLoginUris(row[7]);
                        // ‰∏∫ÊØè‰∏™ URI ÂàõÂª∫‰∏ÄÊù°ËÆ∞ÂΩï
                        uris.forEach(uri => {
                            result.push({
                                url: uri,
                                username: row[8] || '',
                                password: row[9] || '',
                                name: row[3] || ''
                            });
                        });
                    }
                } else { // edge
                    if (row.length >= 4) {
                        result.push({
                            url: row[1] || '',
                            username: row[2] || '',
                            password: row[3] || '',
                            name: row[0] || ''
                        });
                    }
                }
            });

            return result;
        }

        function findDifferences(data1, data2) {
            const differences = [];
            
            // ÂàõÂª∫Êü•ÊâæÁ¥¢Âºï
            const index2 = new Map();
            data2.forEach(item => {
                const key = `${item.url}|${item.username}`;
                index2.set(key, item);
            });

            // Ê£ÄÊü•Á¨¨‰∏Ä‰∏™Êï∞ÊçÆÈõÜ‰∏≠ÁöÑÊØè‰∏™Êù°ÁõÆ
            data1.forEach(item1 => {
                const key = `${item1.url}|${item1.username}`;
                const item2 = index2.get(key);

                if (item2) {
                    // URLÂíåÁî®Êà∑ÂêçÂåπÈÖçÔºå‰ΩÜÂØÜÁ†Å‰∏çÂêå
                    if (item1.password !== item2.password) {
                        differences.push({
                            type: 'password_mismatch',
                            url: item1.url,
                            username: item1.username,
                            name1: item1.name,
                            name2: item2.name,
                            password1: item1.password,
                            password2: item2.password
                        });
                    }
                }
            });

            return differences;
        }

        function displayDifferences(differences, fileName1, fileName2) {
            const compareResult = document.getElementById('compareResult');
            const noMismatchDiv = document.getElementById('noMismatchDiv');
            const hasMismatchDiv = document.getElementById('hasMismatchDiv');
            const mismatchList = document.getElementById('mismatchList');

            // ÊòæÁ§∫ÁªìÊûúÂå∫Âüü
            compareResult.style.display = 'block';
            
            // ÈöêËóèÊâÄÊúâÂ≠êÂå∫Âüü
            noMismatchDiv.style.display = 'none';
            hasMismatchDiv.style.display = 'none';

            if (differences.length === 0) {
                noMismatchDiv.style.display = 'block';
                return;
            }

            hasMismatchDiv.style.display = 'block';
            let html = '';
            differences.forEach(diff => {
                if (diff.type === 'password_mismatch') {
                    html += `
                        <div class="warning">
                            <div class="warning-title">URL: ${diff.url}</div>
                            <div>${t('compare.username')}: ${diff.username}</div>
                            <div>${t('compare.record')}1 (${fileName1}): ${diff.name1 ? `${t('compare.name')}: ${diff.name1}, ` : ''}${t('compare.password')}: ${diff.password1}</div>
                            <div>${t('compare.record')}2 (${fileName2}): ${diff.name2 ? `${t('compare.name')}: ${diff.name2}, ` : ''}${t('compare.password')}: ${diff.password2}</div>
                        </div>
                    `;
                }
            });
            
            mismatchList.innerHTML = html;
        }

        // Ê£ÄÊµãÊñá‰ª∂Ê†ºÂºèÁöÑÂáΩÊï∞
        function detectFileFormat(fileInput, formatInfoId = 'formatInfo', detectedFormatId = 'detectedFormat') {
            const file = fileInput.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const format = detectFormat(text);
                
                // ÊòæÁ§∫Ê£ÄÊµãÂà∞ÁöÑÊ†ºÂºè
                const formatInfo = document.getElementById(formatInfoId);
                const detectedFormatSpan = document.getElementById(detectedFormatId);
                
                if (formatInfo && detectedFormatSpan) {
                    formatInfo.style.display = 'block';
                    
                    if (format === 'bitwarden') {
                        detectedFormatSpan.setAttribute('data-i18n', 'convert.formatBitwarden');
                        detectedFormatSpan.textContent = t('convert.formatBitwarden');
                    } else if (format === 'edge') {
                        detectedFormatSpan.setAttribute('data-i18n', 'convert.formatEdge');
                        detectedFormatSpan.textContent = t('convert.formatEdge');
                    } else {
                        detectedFormatSpan.setAttribute('data-i18n', 'convert.formatUnknown');
                        detectedFormatSpan.textContent = t('convert.formatUnknown');
                    }
                    
                    // ‰øùÂ≠òÊ£ÄÊµãÂà∞ÁöÑÊ†ºÂºèÂà∞Êñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†ÁöÑËá™ÂÆö‰πâÂ±ûÊÄß‰∏≠
                    fileInput.setAttribute('data-format', format);
                }
            };
            reader.readAsText(file);
        }

        // Ê£ÄÊµãCSVÊñá‰ª∂Ê†ºÂºèÁöÑÂáΩÊï∞
        function detectFormat(csvText) {
            try {
                const lines = parseCSV(csvText);
                if (lines.length === 0) {
                    return 'unknown';
                }
                
                const headers = lines[0];
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫BitwardenÊ†ºÂºè
                if (headers.length >= 10 && 
                    headers.includes('folder') && 
                    headers.includes('type') && 
                    headers.includes('login_uri') && 
                    headers.includes('login_username') && 
                    headers.includes('login_password')) {
                    return 'bitwarden';
                }
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫EdgeÊ†ºÂºè
                if (headers.length >= 4 && 
                    headers.includes('name') && 
                    headers.includes('url') && 
                    headers.includes('username') && 
                    headers.includes('password')) {
                    return 'edge';
                }
                
                return 'unknown';
            } catch (error) {
                console.error('Error detecting format:', error);
                return 'unknown';
            }
        }

        function convertFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert(t('messages.selectFile'));
                return;
            }

            // Ëé∑ÂèñÊ£ÄÊµãÂà∞ÁöÑÊ†ºÂºè
            const sourceFormat = fileInput.getAttribute('data-format');
            
            if (!sourceFormat || sourceFormat === 'unknown') {
                alert(t('messages.formatError'));
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const converted = convertFormat(text, sourceFormat);
                downloadCSV(converted, `converted_${sourceFormat === 'bitwarden' ? 'edge' : 'bitwarden'}_${file.name}`);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const result = [];
            let row = [];
            let inQuotes = false;
            let currentValue = '';
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Â§ÑÁêÜËΩ¨‰πâÁöÑÂèåÂºïÂè∑
                        currentValue += '"';
                        i++; // Ë∑≥Ëøá‰∏ã‰∏Ä‰∏™ÂºïÂè∑
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    row.push(currentValue);
                    currentValue = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentValue || row.length > 0) {
                        row.push(currentValue);
                        result.push(row);
                        row = [];
                        currentValue = '';
                    }
                    // Ë∑≥Ëøá \r\n ‰∏≠ÁöÑ \n
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                } else {
                    currentValue += char;
                }
            }
            
            // Â§ÑÁêÜÊúÄÂêé‰∏Ä‰∏™ÂÄºÂíåË°å
            if (currentValue || row.length > 0) {
                row.push(currentValue);
                result.push(row);
            }
            
            return result;
        }

        function escapeCSVField(field) {
            if (field.includes('"') || field.includes(',') || field.includes('\n') || field.includes('\r')) {
                // Â∞ÜÂ≠óÊÆµ‰∏≠ÁöÑÂèåÂºïÂè∑ÊõøÊç¢‰∏∫‰∏§‰∏™ÂèåÂºïÂè∑ÔºåÂπ∂Áî®ÂèåÂºïÂè∑ÂåÖË£πÊï¥‰∏™Â≠óÊÆµ
                return '"' + field.replace(/"/g, '""') + '"';
            }
            return field;
        }

        function convertFormat(csvText, sourceFormat) {
            // Ëß£ÊûêCSV
            const lines = parseCSV(csvText);
            const headers = lines[0];
            const data = lines.slice(1);

            let result = [];

            if (sourceFormat === 'bitwarden') {
                // Bitwarden ËΩ¨ Edge
                result.push(['name', 'url', 'username', 'password', 'note'].map(escapeCSVField).join(','));
                
                const noUrlRecords = [];
                
                data.forEach(row => {
                    if (row.length < 10) return; // Ë∑≥ËøáÊó†ÊïàË°å
                    const urls = parseLoginUris(row[7]); // ‰ΩøÁî®parseLoginUrisËß£ÊûêÂ§ö‰∏™URL
                    const username = row[8] || '';
                    const password = row[9] || '';
                    const notes = row[4] || '';
                    const name = row[3] || '';
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÊúâÊïàÁöÑ URL
                    if (!urls[0]) {
                        noUrlRecords.push({ name, username });
                        return;
                    }
                    
                    // ‰∏∫ÊØè‰∏™URLÂàõÂª∫‰∏ÄÊù°ËÆ∞ÂΩï
                    urls.forEach(url => {
                        // ‰ªé URL ÊèêÂèñÂüüÂêç‰Ωú‰∏∫ name
                        const urlName = extractDomainFromUrl(url);
                        result.push([urlName, url, username, password, notes].map(escapeCSVField).join(','));
                    });
                });
                
                // Ëé∑ÂèñÁªìÊûúÂÖÉÁ¥†
                const convertResult = document.getElementById('convertResult');
                const recordsList = document.getElementById('noUrlRecordsList');
                
                // Â¶ÇÊûúÊúâÊ≤°Êúâ URL ÁöÑËÆ∞ÂΩïÔºåÊòæÁ§∫Ë≠¶Âëä
                if (noUrlRecords.length > 0) {
                    convertResult.style.display = 'block';
                    let html = '';
                    noUrlRecords.forEach(record => {
                        html += `<div>${record.name ? `${t('compare.name')}: ${record.name}, ` : ''}${t('compare.username')}: ${record.username}</div>`;
                    });
                    recordsList.innerHTML = html;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊó† URL ËÆ∞ÂΩïÔºåÈöêËóèÁªìÊûú
                    convertResult.style.display = 'none';
                }
            } else {
                // Edge ËΩ¨ Bitwarden
                result.push(['folder', 'favorite', 'type', 'name', 'notes', 'fields', 'reprompt', 'login_uri', 'login_username', 'login_password', 'login_totp'].map(escapeCSVField).join(','));
                
                data.forEach(row => {
                    if (row.length < 4) return; // Ë∑≥ËøáÊó†ÊïàË°å
                    const newRow = [
                        '', // folder
                        '', // favorite
                        'login', // type
                        row[0] || '', // name
                        row[4] || '', // notes
                        '', // fields
                        '0', // reprompt
                        row[1] || '', // login_uri
                        row[2] || '', // login_username
                        row[3] || '', // login_password
                        '' // login_totp
                    ];
                    result.push(newRow.map(escapeCSVField).join(','));
                });
                
                // Edge ËΩ¨ Bitwarden Êó∂ÈöêËóè convertResult
                const convertResult = document.getElementById('convertResult');
                convertResult.style.display = 'none';
            }

            return result.join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (navigator.msSaveBlob) {
                navigator.msSaveBlob(blob, filename);
                return;
            }
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
</html>